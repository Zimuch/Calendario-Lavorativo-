<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Calendario Lavorativo By Simon</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2180ad">
    <meta name="description" content="Gestisci i tuoi turni di lavoro e calcola lo stipendio">
    
    <!-- Apple iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calendario">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232180ad' width='192' height='192' rx='45'/><text x='96' y='120' font-size='100' fill='white' text-anchor='middle' font-weight='bold'>üìÖ</text></svg>">
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>

    <style>
        :root {
            --color-primary: #2180ad;
            --color-primary-hover: #1a6a8f;
            --color-bg: #1a1a1a;
            --color-surface: #2d2d2d;
            --color-text: #e0e0e0;
            --color-text-light: #a0a0a0;
            --color-border: #444;
            --color-success: #22b14c;
            --color-warning: #ff9800;
            --color-error: #e74c3c;
            --radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
            padding-bottom: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
            font-size: 28px;
            color: var(--color-primary);
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            margin-bottom: 20px;
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: var(--color-text-light);
            margin-bottom: 8px;
        }

        input, select, button {
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 173, 0.3);
        }

        input, select {
            background-color: #333;
            color: var(--color-text);
        }

        button {
            background: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            padding: 10px 20px;
        }

        button:hover {
            background: var(--color-primary-hover);
        }

        button.danger {
            background: var(--color-error);
        }

        button.danger:hover {
            background: #c0392b;
        }

        .controls button {
            align-self: flex-end;
            height: fit-content;
        }

        .calendar-container {
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .week-selector {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-info {
            font-size: 16px;
            font-weight: 600;
            color: var(--color-primary);
        }

        .week-nav {
            display: flex;
            gap: 10px;
        }

        .week-nav button {
            padding: 8px 15px;
            font-size: 13px;
            background: var(--color-primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            border-radius: var(--radius);
        }

        .week-nav button:hover {
            background: var(--color-primary-hover);
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .day-card {
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            border-radius: var(--radius);
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 150px;
            display: flex;
            flex-direction: column;
        }

        .day-card:hover {
            border-color: var(--color-primary);
            background: rgba(33, 128, 173, 0.05);
        }

        .day-card.selected {
            border-color: var(--color-primary);
            background: rgba(33, 128, 173, 0.1);
        }

        .day-card.has-shift-complete {
            background: rgba(34, 177, 76, 0.15);
            border-color: var(--color-success);
        }

        .day-card.has-shift-complete:hover {
            background: rgba(34, 177, 76, 0.25);
        }

        .day-card.has-shift-incomplete {
            background: rgba(231, 76, 60, 0.15);
            border-color: var(--color-error);
        }

        .day-card.has-shift-incomplete:hover {
            background: rgba(231, 76, 60, 0.25);
        }

        .day-name {
            font-weight: 700;
            font-size: 14px;
            text-transform: uppercase;
            color: var(--color-text-light);
            margin-bottom: 5px;
        }

        .day-date {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 10px;
        }

        .day-shift {
            font-size: 13px;
            color: var(--color-text);
            background: white;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            flex-grow: 1;
        }

        .shift-panel {
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .shift-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .shift-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .bonus-section {
            background: var(--color-bg);
            padding: 15px;
            border-radius: var(--radius);
            margin-top: 15px;
        }

        .bonus-section h3 {
            margin: 0 0 15px 0;
            color: var(--color-primary);
            font-size: 16px;
        }

        .bonus-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .bonus-item {
            display: flex;
            flex-direction: column;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: var(--color-bg);
            padding: 15px;
            border-radius: var(--radius);
            border-left: 4px solid var(--color-primary);
        }

        .stat-label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--color-text-light);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-box.success {
            border-left-color: var(--color-success);
        }

        .stat-box.success .stat-value {
            color: var(--color-success);
        }

        .stat-box.warning {
            border-left-color: var(--color-warning);
        }

        .stat-box.warning .stat-value {
            color: var(--color-warning);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: flex-end;
        }

        .action-buttons button {
            flex: 1;
            max-width: 150px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            padding: 30px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            margin-bottom: 20px;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--color-primary);
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .summary-section {
            background: var(--color-surface);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .summary-section h2 {
            margin-top: 0;
            color: var(--color-primary);
            font-size: 18px;
        }

        .month-selector-container {
            display: flex;
            align-items: flex-end;
            gap: 15px;
            margin-bottom: 20px;
        }

        .month-selector-container .form-group {
            flex: 1;
            max-width: 300px;
        }

        .day-shift {
            font-size: 13px;
            color: var(--color-text);
            background: #333;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            flex-grow: 1;
        }

        .domenica-badge {
            display: inline-block;
            background: var(--color-warning);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr;
            }

            .days-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .shift-form {
                grid-template-columns: 1fr;
            }

            .month-selector-container {
                flex-direction: column;
            }

            body {
                padding: 15px;
            }

            h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìÖ Calendario Lavorativo By Simon</h1>
            <p style="color: var(--color-text-light); margin: 5px 0 0 0;">Gestisci i tuoi turni di lavoro e calcola lo stipendio</p>
        </header>

        <div class="controls">
            <div class="form-group">
                <label for="hourlyRate">Paga Oraria (‚Ç¨)</label>
                <input type="number" id="hourlyRate" placeholder="es. 12.50" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label for="weekStart">Settimana da:</label>
                <input type="date" id="weekStart">
            </div>
            <button onclick="app.exportData()">üì• Esporta Dati</button>
        </div>

        <div class="calendar-container">
            <div class="week-selector">
                <button class="controls" onclick="app.previousWeek()">‚Üê Settimana Precedente</button>
                <div class="week-info" id="weekInfo"></div>
                <button class="controls" onclick="app.nextWeek()">Settimana Successiva ‚Üí</button>
            </div>

            <div class="days-grid" id="daysGrid"></div>
        </div>

        <div class="shift-panel">
            <h2 style="margin-top: 0; color: var(--color-primary);">Dettagli Turno <span id="domenicarBadge"></span></h2>
            <div id="selectedDayInfo" style="color: var(--color-text-light); margin-bottom: 15px;">Seleziona un giorno per modificare il turno</div>

            <div class="shift-form" id="shiftForm" style="display: none;">
                <div class="form-group">
                    <label for="shiftStart">Inizio Turno</label>
                    <input type="time" id="shiftStart">
                </div>
                <div class="form-group">
                    <label for="shiftEnd">Fine Turno</label>
                    <input type="time" id="shiftEnd">
                </div>
                <div class="form-group">
                    <label for="hoursWorked">Ore Lavorate</label>
                    <input type="number" id="hoursWorked" placeholder="es. 8" step="0.5" min="0">
                </div>
                <div class="form-group">
                    <label for="hourlyRateDay">Paga Oraria Giorno (‚Ç¨)</label>
                    <input type="number" id="hourlyRateDay" placeholder="es. 12.50" step="0.01" min="0">
                </div>
            </div>

            <div class="bonus-section" id="bonusSection" style="display: none;">
                <h3>Straordinari</h3>
                <div id="overtimeContainer"></div>
                <button onclick="app.addOvertimeRow()" style="margin-top: 15px; width: 100%; padding: 10px;">+ Aggiungi Straordinario</button>
            </div>

            <div class="shift-details" id="shiftDetails" style="display: none;">
                <div class="stat-box">
                    <div class="stat-label">Paga Base <span id="domenicarLabel"></span></div>
                    <div class="stat-value" id="basePay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box success">
                    <div class="stat-label">Straordinari</div>
                    <div class="stat-value" id="overtimePay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box success">
                    <div class="stat-label">Totale Giorno</div>
                    <div class="stat-value" id="dayTotal">‚Ç¨0.00</div>
                </div>
            </div>

            <div class="action-buttons" id="actionButtons" style="display: none;">
                <button onclick="app.saveShift()">üíæ Salva Turno</button>
                <button class="danger" onclick="app.deleteShift()">üóëÔ∏è Cancella Turno</button>
            </div>
        </div>

        <div class="summary-section">
            <h2>Riepilogo Settimana</h2>
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">Ore Lavorate</div>
                    <div class="stat-value" id="totalHours">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Paga Base</div>
                    <div class="stat-value" id="totalBasePay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box success">
                    <div class="stat-label">Straordinari</div>
                    <div class="stat-value" id="totalOvertimePay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-label">Maggiorazione (+20%)</div>
                    <div class="stat-value" id="totalOverageHoursPay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box success">
                    <div class="stat-label">Totale Settimana</div>
                    <div class="stat-value" id="totalWeekPay">‚Ç¨0.00</div>
                </div>
            </div>
        </div>

        <div class="summary-section" style="margin-top: 20px;">
            <div class="month-selector-container">
                <div class="form-group">
                    <label for="monthSelector">Seleziona Mese</label>
                    <select id="monthSelector"></select>
                </div>
            </div>

            <h2 style="margin-top: 0; color: var(--color-primary);">Riepilogo Mese</h2>
            <div class="stats-container">
                <div class="stat-box">
                    <div class="stat-label">Ore Lavorate</div>
                    <div class="stat-value" id="monthTotalHours">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Paga Base</div>
                    <div class="stat-value" id="monthTotalBasePay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box success">
                    <div class="stat-label">Straordinari</div>
                    <div class="stat-value" id="monthTotalOvertimePay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box warning">
                    <div class="stat-label">Maggiorazione (+20%)</div>
                    <div class="stat-value" id="monthTotalOverageHoursPay">‚Ç¨0.00</div>
                </div>
                <div class="stat-box success">
                    <div class="stat-label">Totale Mese</div>
                    <div class="stat-value" id="monthTotalWeekPay">‚Ç¨0.00</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            shifts: {},
            selectedDate: null,
            currentWeekStart: null,
            selectedMonth: null,

            init() {
                this.loadData();
                this.setDefaultWeek();
                this.initMonthSelector();
                this.attachEventListeners();
                this.render();
            },

            setDefaultWeek() {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -2 : 5);
                this.currentWeekStart = new Date(today.setDate(diff));
                this.currentWeekStart.setHours(0, 0, 0, 0);
                document.getElementById('weekStart').valueAsDate = this.currentWeekStart;
            },

            attachEventListeners() {
                document.getElementById('weekStart').addEventListener('change', (e) => {
                    this.currentWeekStart = new Date(e.target.value);
                    this.currentWeekStart.setHours(0, 0, 0, 0);
                    this.render();
                });

                document.getElementById('hourlyRate').addEventListener('change', (e) => {
                    if (this.selectedDate) {
                        this.updateCalculations();
                    }
                });

                ['shiftStart', 'shiftEnd', 'hoursWorked', 'hourlyRateDay'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', () => this.updateCalculations());
                });
            },

            render() {
                this.renderWeek();
                this.updateSummary();
                this.updateMonthlySummary();
                this.clearSelection();
            },

            renderWeek() {
                const start = new Date(this.currentWeekStart);
                const days = ['Venerd√¨', 'Sabato', 'Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨'];
                const grid = document.getElementById('daysGrid');
                grid.innerHTML = '';

                const weekEnd = new Date(start);
                weekEnd.setDate(weekEnd.getDate() + 6);

                document.getElementById('weekInfo').innerHTML = 
                    `${start.toLocaleDateString('it-IT')} - ${weekEnd.toLocaleDateString('it-IT')}`;

                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(start.getTime());
                    currentDate.setDate(currentDate.getDate() + i);
                    const dateStr = this.formatDateForStorage(currentDate);
                    const shift = this.shifts[dateStr];

                    const card = document.createElement('div');
                    card.className = 'day-card';
                    
                    if (shift) {
                        const hours = parseFloat(shift.hours) || 0;
                        if (hours > 0) {
                            card.classList.add('has-shift-complete');
                        } else {
                            card.classList.add('has-shift-incomplete');
                        }
                    }
                    
                    card.innerHTML = `
                        <div class="day-name">${days[i]}</div>
                        <div class="day-date">${currentDate.getDate()}</div>
                        ${shift ? `
                            <div class="day-shift"><strong>Inizio:</strong> ${shift.startTime || '-'}</div>
                            <div class="day-shift"><strong>Fine:</strong> ${shift.endTime || '-'}</div>
                            <div class="day-shift"><strong>Ore:</strong> ${shift.hours || 0}h</div>
                            <div class="day-shift"><strong>Totale:</strong> ‚Ç¨${this.calculateDayTotal(shift, dateStr).toFixed(2)}</div>
                        ` : '<div class="day-shift" style="color: var(--color-text-light);">Nessun turno</div>'}
                    `;
                    card.onclick = () => this.selectDay(dateStr);
                    grid.appendChild(card);
                }
            },

            formatDateForStorage(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            isDomenica(dateStr) {
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                return date.getDay() === 0;
            },

            selectDay(dateStr) {
                this.selectedDate = dateStr;
                const shift = this.shifts[dateStr] || {};
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                const isDomenica = this.isDomenica(dateStr);

                document.getElementById('selectedDayInfo').innerHTML = 
                    `<strong>${date.toLocaleDateString('it-IT', { weekday: 'long' })}, ${date.toLocaleDateString('it-IT')}</strong>`;

                if (isDomenica) {
                    document.getElementById('domenicarBadge').innerHTML = '<span class="domenica-badge">+10% Domenica</span>';
                    document.getElementById('domenicarLabel').innerHTML = '(+10% domenica)';
                } else {
                    document.getElementById('domenicarBadge').innerHTML = '';
                    document.getElementById('domenicarLabel').innerHTML = '';
                }

                document.getElementById('shiftStart').value = shift.startTime || '';
                document.getElementById('shiftEnd').value = shift.endTime || '';
                document.getElementById('hoursWorked').value = shift.hours || '';
                document.getElementById('hourlyRateDay').value = shift.hourlyRate || document.getElementById('hourlyRate').value || '';

                document.getElementById('shiftForm').style.display = 'grid';
                document.getElementById('bonusSection').style.display = 'block';
                document.getElementById('shiftDetails').style.display = 'grid';
                document.getElementById('actionButtons').style.display = 'flex';

                this.renderOvertimeInputs(shift.overtimes || []);

                document.querySelectorAll('.day-card').forEach(c => c.classList.remove('selected'));
                event.currentTarget.classList.add('selected');

                this.updateCalculations();
            },

            renderOvertimeInputs(overtimes) {
                const container = document.getElementById('overtimeContainer');
                container.innerHTML = '';
                
                overtimes.forEach((overtime, index) => {
                    this.addOvertimeRow(overtime.hours, overtime.type);
                });

                if (overtimes.length === 0) {
                    this.addOvertimeRow();
                }
            },

            addOvertimeRow(hours = '', type = 'domenicale') {
                const container = document.getElementById('overtimeContainer');
                const rowId = 'overtime-' + Date.now() + Math.random();
                
                const row = document.createElement('div');
                row.className = 'overtime-row';
                row.style.display = 'grid';
                row.style.gridTemplateColumns = '1fr 1fr auto';
                row.style.gap = '10px';
                row.style.marginBottom = '10px';
                row.style.alignItems = 'flex-end';
                
                row.innerHTML = `
                    <div class="bonus-item">
                        <label>Ore Straordinario</label>
                        <input type="number" class="overtime-input" value="${hours}" placeholder="0" step="0.5" min="0">
                    </div>
                    <div class="bonus-item">
                        <label>Tipo</label>
                        <select class="overtime-type-select">
                            <option value="domenicale" ${type === 'domenicale' ? 'selected' : ''}>10%</option>
                            <option value="notturno" ${type === 'notturno' ? 'selected' : ''}>20%</option>
                            <option value="aggiuntivo" ${type === 'aggiuntivo' ? 'selected' : ''}>30%</option>
                            <option value="festivo" ${type === 'festivo' ? 'selected' : ''}>80%</option>
                        </select>
                    </div>
                    <button type="button" class="btn-remove-overtime" onclick="app.removeOvertimeRow(this)" style="background: var(--color-error); padding: 10px 15px; color: white; border: none; cursor: pointer; border-radius: var(--radius); font-weight: 600;">üóëÔ∏è</button>
                `;
                
                container.appendChild(row);
                
                const inputs = row.querySelectorAll('.overtime-input, .overtime-type-select');
                inputs.forEach(input => {
                    input.addEventListener('change', () => this.updateCalculations());
                });
            },

            removeOvertimeRow(button) {
                button.closest('.overtime-row').remove();
                this.updateCalculations();
            },

            calculateDayTotal(shift, dateStr) {
                const hourlyRate = parseFloat(shift.hourlyRate) || parseFloat(document.getElementById('hourlyRate').value) || 0;
                const hours = parseFloat(shift.hours) || 0;
                
                // Paga base SENZA maggiorazione domenica
                const basePay = hours * hourlyRate;

                let totalOvertimePay = 0;
                if (shift.overtimes && Array.isArray(shift.overtimes)) {
                    shift.overtimes.forEach(overtime => {
                        const overtimeHours = parseFloat(overtime.hours) || 0;
                        const percentages = {
                            'domenicale': 10,
                            'notturno': 20,
                            'aggiuntivo': 30,
                            'festivo': 80
                        };
                        const percentage = percentages[overtime.type] || 10;
                        const majorazionePer1Ora = (basePay * percentage) / 100 / hours;
                        totalOvertimePay += overtimeHours * majorazionePer1Ora;
                    });
                }

                // Aggiungi +10% domenica agli straordinari
                const isDomenica = this.isDomenica(dateStr);
                if (isDomenica) {
                    const maggiorazioneDomenica = basePay * 0.1;
                    totalOvertimePay += maggiorazioneDomenica;
                }

                return basePay + totalOvertimePay;
            },

            updateCalculations() {
                const hourlyRate = parseFloat(document.getElementById('hourlyRateDay').value) || parseFloat(document.getElementById('hourlyRate').value) || 0;
                const hours = parseFloat(document.getElementById('hoursWorked').value) || 0;
                
                // Paga base SENZA maggiorazione domenica
                const basePay = hours * hourlyRate;

                let totalOvertimePay = 0;
                const overtimeInputs = document.querySelectorAll('.overtime-input');
                overtimeInputs.forEach(input => {
                    const row = input.closest('.overtime-row');
                    const overtimeHours = parseFloat(input.value) || 0;
                    const typeSelect = row.querySelector('.overtime-type-select');
                    const typeValue = typeSelect.value;
                    
                    const percentages = {
                        'domenicale': 10,
                        'notturno': 20,
                        'aggiuntivo': 30,
                        'festivo': 80
                    };
                    const percentage = percentages[typeValue] || 10;
                    const majorazionePer1Ora = (basePay * percentage) / 100 / hours;
                    totalOvertimePay += overtimeHours * majorazionePer1Ora;
                });

                // Aggiungi +10% domenica agli straordinari
                const isDomenica = this.isDomenica(this.selectedDate);
                if (isDomenica) {
                    const maggiorazioneDomenica = basePay * 0.1;
                    totalOvertimePay += maggiorazioneDomenica;
                }

                const dayTotal = basePay + totalOvertimePay;

                document.getElementById('basePay').textContent = '‚Ç¨' + basePay.toFixed(2);
                document.getElementById('overtimePay').textContent = '‚Ç¨' + totalOvertimePay.toFixed(2);
                document.getElementById('dayTotal').textContent = '‚Ç¨' + dayTotal.toFixed(2);
            },

            saveShift() {
                if (!this.selectedDate) return;

                const overtimes = [];
                const overtimeInputs = document.querySelectorAll('.overtime-input');
                overtimeInputs.forEach(input => {
                    const row = input.closest('.overtime-row');
                    const hours = parseFloat(input.value) || 0;
                    const type = row.querySelector('.overtime-type-select').value;
                    if (hours > 0) {
                        overtimes.push({ hours, type });
                    }
                });

                this.shifts[this.selectedDate] = {
                    startTime: document.getElementById('shiftStart').value,
                    endTime: document.getElementById('shiftEnd').value,
                    hours: parseFloat(document.getElementById('hoursWorked').value) || 0,
                    hourlyRate: parseFloat(document.getElementById('hourlyRateDay').value) || parseFloat(document.getElementById('hourlyRate').value) || 0,
                    overtimes: overtimes
                };

                this.saveData();
                this.render();
                alert('‚úÖ Turno salvato con successo!');
            },

            deleteShift() {
                if (!this.selectedDate) return;
                if (!confirm('Sei sicuro di voler eliminare questo turno?')) return;

                delete this.shifts[this.selectedDate];
                this.saveData();
                this.render();
                alert('üóëÔ∏è Turno eliminato!');
            },

            clearSelection() {
                this.selectedDate = null;
                document.getElementById('shiftForm').style.display = 'none';
                document.getElementById('bonusSection').style.display = 'none';
                document.getElementById('shiftDetails').style.display = 'none';
                document.getElementById('actionButtons').style.display = 'none';
                document.getElementById('selectedDayInfo').innerHTML = 'Seleziona un giorno per modificare il turno';
                document.getElementById('domenicarBadge').innerHTML = '';
                document.getElementById('domenicarLabel').innerHTML = '';
                document.querySelectorAll('.day-card').forEach(c => c.classList.remove('selected'));
            },

            updateSummary() {
                const start = new Date(this.currentWeekStart);
                let totalHours = 0, totalBasePay = 0, totalOvertimePay = 0, normalHours = 0;

                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(start.getTime());
                    currentDate.setDate(currentDate.getDate() + i);
                    const dateStr = this.formatDateForStorage(currentDate);
                    const shift = this.shifts[dateStr];

                    if (shift) {
                        const hourlyRate = shift.hourlyRate;
                        const hours = shift.hours;
                        
                        // Paga base SENZA maggiorazione domenica
                        const basePay = hours * hourlyRate;

                        let overtimePay = 0;
                        if (shift.overtimes && Array.isArray(shift.overtimes)) {
                            shift.overtimes.forEach(overtime => {
                                const overtimeHours = parseFloat(overtime.hours) || 0;
                                const percentages = {
                                    'domenicale': 10,
                                    'notturno': 20,
                                    'aggiuntivo': 30,
                                    'festivo': 80
                                };
                                const percentage = percentages[overtime.type] || 10;
                                const majorazionePer1Ora = (basePay * percentage) / 100 / hours;
                                overtimePay += overtimeHours * majorazionePer1Ora;
                            });
                        }

                        // Aggiungi +10% domenica agli straordinari
                        const isDomenica = this.isDomenica(dateStr);
                        if (isDomenica) {
                            const maggiorazioneDomenica = basePay * 0.1;
                            overtimePay += maggiorazioneDomenica;
                        }

                        let overtimeHours = 0;
                        if (shift.overtimes && Array.isArray(shift.overtimes)) {
                            shift.overtimes.forEach(overtime => {
                                overtimeHours += parseFloat(overtime.hours) || 0;
                            });
                        }

                        totalHours += hours + overtimeHours;
                        normalHours += hours;
                        totalBasePay += basePay;
                        totalOvertimePay += overtimePay;
                    }
                }

                let overageHoursPay = 0;
                if (normalHours > 24) {
                    const overageHours = normalHours - 24;
                    const globalHourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
                    overageHoursPay = overageHours * globalHourlyRate * 0.2;
                }

                const totalWeekPay = totalBasePay + totalOvertimePay + overageHoursPay;

                document.getElementById('totalHours').textContent = totalHours.toFixed(1);
                document.getElementById('totalBasePay').textContent = '‚Ç¨' + totalBasePay.toFixed(2);
                document.getElementById('totalOvertimePay').textContent = '‚Ç¨' + totalOvertimePay.toFixed(2);
                document.getElementById('totalOverageHoursPay').textContent = '‚Ç¨' + overageHoursPay.toFixed(2);
                document.getElementById('totalWeekPay').textContent = '‚Ç¨' + totalWeekPay.toFixed(2);
            },

            initMonthSelector() {
                const select = document.getElementById('monthSelector');
                const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
                
                const startYear = 2020;
                const endYear = new Date().getFullYear() + 2;
                
                for (let year = startYear; year <= endYear; year++) {
                    for (let month = 0; month < 12; month++) {
                        const option = document.createElement('option');
                        option.value = `${year}-${month}`;
                        option.textContent = `${months[month]} ${year}`;
                        select.appendChild(option);
                    }
                }
                
                const today = new Date();
                select.value = `${today.getFullYear()}-${today.getMonth()}`;
                
                select.addEventListener('change', (e) => {
                    const [year, month] = e.target.value.split('-').map(Number);
                    this.selectedMonth = { year, month };
                    this.updateMonthlySummary();
                });
            },

            updateMonthlySummary() {
                const select = document.getElementById('monthSelector');
                const [selectedYear, selectedMonth] = select.value.split('-').map(Number);
                
                let totalHours = 0, totalBasePay = 0, totalOvertimePay = 0, overageHoursPay = 0;
                const globalHourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;

                // Primo ciclo: calcola paga base e straordinari
                for (const dateStr in this.shifts) {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    if (date.getMonth() === selectedMonth && date.getFullYear() === selectedYear) {
                        const shift = this.shifts[dateStr];
                        const hourlyRate = shift.hourlyRate;
                        const hours = shift.hours;
                        
                        // Paga base SENZA maggiorazione domenica
                        const basePay = hours * hourlyRate;

                        let overtimePay = 0;
                        let overtimeHours = 0;
                        if (shift.overtimes && Array.isArray(shift.overtimes)) {
                            shift.overtimes.forEach(overtime => {
                                const hours = parseFloat(overtime.hours) || 0;
                                const percentages = {
                                    'domenicale': 10,
                                    'notturno': 20,
                                    'aggiuntivo': 30,
                                    'festivo': 80
                                };
                                const percentage = percentages[overtime.type] || 10;
                                const majorazionePer1Ora = (basePay * percentage) / 100 / shift.hours;
                                overtimePay += hours * majorazionePer1Ora;
                                overtimeHours += hours;
                            });
                        }

                        // Aggiungi +10% domenica agli straordinari
                        const isDomenica = this.isDomenica(dateStr);
                        if (isDomenica) {
                            const maggiorazioneDomenica = basePay * 0.1;
                            overtimePay += maggiorazioneDomenica;
                        }

                        totalHours += hours + overtimeHours;
                        totalBasePay += basePay;
                        totalOvertimePay += overtimePay;
                    }
                }

                // Secondo ciclo: calcola maggiorazione +20% per ore oltre 24 per settimana
                const firstDayOfMonth = new Date(selectedYear, selectedMonth, 1);
                const lastDayOfMonth = new Date(selectedYear, selectedMonth + 1, 0);
                
                // Trova il primo venerd√¨ del mese
                let currentDate = new Date(firstDayOfMonth);
                const dayOfWeek = currentDate.getDay();
                const daysToFriday = (5 - dayOfWeek + 7) % 7;
                currentDate.setDate(currentDate.getDate() + (daysToFriday === 0 && currentDate.getDate() === 1 ? 0 : daysToFriday));
                
                // Itera per ogni settimana a partire dal primo venerd√¨
                while (currentDate <= lastDayOfMonth) {
                    let weeklyHours = 0;
                    
                    // Conta le ore da venerd√¨ a gioved√¨
                    for (let i = 0; i < 7; i++) {
                        const tempDate = new Date(currentDate);
                        tempDate.setDate(tempDate.getDate() + i);
                        
                        if (tempDate > lastDayOfMonth) break;
                        
                        const dateStr = this.formatDateForStorage(tempDate);
                        const shift = this.shifts[dateStr];
                        
                        if (shift) {
                            weeklyHours += parseFloat(shift.hours) || 0;
                        }
                    }
                    
                    if (weeklyHours > 24) {
                        const overageHours = weeklyHours - 24;
                        overageHoursPay += overageHours * globalHourlyRate * 0.2;
                    }
                    
                    // Passa alla prossima settimana
                    currentDate.setDate(currentDate.getDate() + 7);
                }

                const totalMonthPay = totalBasePay + totalOvertimePay + overageHoursPay;

                document.getElementById('monthTotalHours').textContent = totalHours.toFixed(1);
                document.getElementById('monthTotalBasePay').textContent = '‚Ç¨' + totalBasePay.toFixed(2);
                document.getElementById('monthTotalOvertimePay').textContent = '‚Ç¨' + totalOvertimePay.toFixed(2);
                document.getElementById('monthTotalOverageHoursPay').textContent = '‚Ç¨' + overageHoursPay.toFixed(2);
                document.getElementById('monthTotalWeekPay').textContent = '‚Ç¨' + totalMonthPay.toFixed(2);
            },

            previousWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() - 7);
                document.getElementById('weekStart').valueAsDate = this.currentWeekStart;
                this.render();
            },

            nextWeek() {
                this.currentWeekStart.setDate(this.currentWeekStart.getDate() + 7);
                document.getElementById('weekStart').valueAsDate = this.currentWeekStart;
                this.render();
            },

            saveData() {
                const globalHourlyRate = document.getElementById('hourlyRate').value;
                const data = {
                    hourlyRate: globalHourlyRate,
                    shifts: this.shifts
                };
                localStorage.setItem('shiftCalendarData', JSON.stringify(data));
            },

            loadData() {
                try {
                    const data = JSON.parse(localStorage.getItem('shiftCalendarData') || '{}');
                    this.shifts = data.shifts || {};
                    if (data.hourlyRate) {
                        document.getElementById('hourlyRate').value = data.hourlyRate;
                    }
                } catch (e) {
                    console.log('No saved data found');
                }
            },

            exportData() {
                const hourlyRate = parseFloat(document.getElementById('hourlyRate').value) || 0;
                const select = document.getElementById('monthSelector');
                const [selectedYear, selectedMonth] = select.value.split('-').map(Number);
                
                let csv = 'Data,Giorno,Inizio Turno,Fine Turno,Ore Lavorate,Paga Oraria,Paga Base,Straordinari,Totale Giorno\n';
                
                let totalHours = 0, totalBasePay = 0, totalOvertimePay = 0;
                
                for (const dateStr in this.shifts) {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    
                    if (date.getMonth() === selectedMonth && date.getFullYear() === selectedYear) {
                        const shift = this.shifts[dateStr];
                        const dayNames = ['Domenica', 'Luned√¨', 'Marted√¨', 'Mercoled√¨', 'Gioved√¨', 'Venerd√¨', 'Sabato'];
                        const dayName = dayNames[date.getDay()];
                        
                        const shiftHourlyRate = shift.hourlyRate || hourlyRate;
                        const hours = parseFloat(shift.hours) || 0;
                        
                        // Paga base SENZA maggiorazione domenica
                        const basePay = hours * shiftHourlyRate;
                        
                        let overtimePay = 0;
                        if (shift.overtimes && Array.isArray(shift.overtimes)) {
                            shift.overtimes.forEach(overtime => {
                                const overtimeHours = parseFloat(overtime.hours) || 0;
                                const percentages = {
                                    'domenicale': 10,
                                    'notturno': 20,
                                    'aggiuntivo': 30,
                                    'festivo': 80
                                };
                                const percentage = percentages[overtime.type] || 10;
                                const majorazionePer1Ora = (basePay * percentage) / 100 / hours;
                                overtimePay += overtimeHours * majorazionePer1Ora;
                            });
                        }

                        // Aggiungi +10% domenica agli straordinari
                        const isDomenica = this.isDomenica(dateStr);
                        if (isDomenica) {
                            const maggiorazioneDomenica = basePay * 0.1;
                            overtimePay += maggiorazioneDomenica;
                        }
                        
                        const dayTotal = basePay + overtimePay;
                        totalHours += hours;
                        totalBasePay += basePay;
                        totalOvertimePay += overtimePay;
                        
                        const dateFormatted = date.toLocaleDateString('it-IT');
                        csv += `"${dateFormatted}","${dayName}","${shift.startTime || '-'}","${shift.endTime || '-'}",${hours},${shiftHourlyRate.toFixed(2)},${basePay.toFixed(2)},${overtimePay.toFixed(2)},${dayTotal.toFixed(2)}\n`;
                    }
                }
                
                csv += '\n';
                csv += 'RIEPILOGO MESE,,,,,,,\n';
                csv += `"Ore Totali","","","",${totalHours.toFixed(1)},"","${totalBasePay.toFixed(2)}","${totalOvertimePay.toFixed(2)}","${(totalBasePay + totalOvertimePay).toFixed(2)}"\n`;
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `turni-${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>